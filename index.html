<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Preview & Upload</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #4f46e5;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">

    <!-- Main Container -->
    <div class="container max-w-4xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
        
        <!-- Header Section -->
        <div class="p-6 border-b border-gray-100 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">Upload to Drive</h1>
                <p class="text-gray-500 text-sm mt-1">Select images to upload to Sheet & Drive</p>
            </div>
            <!-- Settings for Script URL (Optional UI for ease of use) -->
            <div class="relative group">
                <button id="settingsBtn" class="text-gray-400 hover:text-indigo-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Content Section -->
        <div class="p-6">
            <!-- Script URL Input (Hidden by default or shown for demo) -->
            <div id="urlConfig" class="mb-4 hidden">
                <label class="block text-xs font-medium text-gray-700 mb-1">Google App Script Web App URL</label>
                <input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/s/..." class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>

            <!-- File Input -->
            <div class="mb-6">
                <label class="block w-full cursor-pointer group">
                    <input type="file" id="fileInput" multiple accept="image/*" 
                        class="block w-full text-sm text-slate-500
                        file:mr-4 file:py-2.5 file:px-6
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-indigo-50 file:text-indigo-600
                        hover:file:bg-indigo-100
                        transition-all duration-300
                        cursor-pointer focus:outline-none"
                    />
                </label>
            </div>

            <!-- Progress Bar (Hidden initially) -->
            <div id="progressContainer" class="hidden mb-6">
                <div class="flex justify-between mb-1">
                    <span id="progressText" class="text-sm font-medium text-indigo-700">Uploading...</span>
                    <span id="progressPercentage" class="text-sm font-medium text-indigo-700">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progressBar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

            <!-- Status Message -->
            <div id="statusMessage" class="hidden mb-4 p-4 rounded-md text-sm"></div>

            <!-- Preview Grid -->
            <div id="preview" class="grid grid-cols-2 sm:grid-cols-3 gap-4 min-h-[100px]">
                <div id="placeholder" class="col-span-full flex flex-col items-center justify-center text-gray-300 py-10 border-2 border-dashed border-gray-200 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <span class="text-sm">No images selected</span>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-between items-center">
            <div class="text-xs text-gray-400">
                <span id="count">0 files</span> selected
            </div>
            <button id="uploadBtn" disabled class="flex items-center space-x-2 bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white px-6 py-2 rounded-full font-medium transition-all duration-300 shadow-sm hover:shadow-md">
                <span id="btnText">Upload to Drive</span>
                <div id="btnLoader" class="loader hidden"></div>
            </button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // Keeps the existing URL as requested
        let SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzhwRful664B9tqkLsCJo2ZVTEKSt77vB9khTAYVSWj9zi0qDYulAC-j6UgRGISGMXr8A/exec"; 
        
        // --- DOM ELEMENTS ---
        const input = document.getElementById("fileInput");
        const preview = document.getElementById("preview");
        const placeholder = document.getElementById("placeholder");
        const countSpan = document.getElementById("count");
        const uploadBtn = document.getElementById("uploadBtn");
        const btnText = document.getElementById("btnText");
        const btnLoader = document.getElementById("btnLoader");
        const settingsBtn = document.getElementById("settingsBtn");
        const urlConfig = document.getElementById("urlConfig");
        const scriptUrlInput = document.getElementById("scriptUrl");
        const progressContainer = document.getElementById("progressContainer");
        const progressBar = document.getElementById("progressBar");
        const progressPercentage = document.getElementById("progressPercentage");
        const statusMessage = document.getElementById("statusMessage");

        // --- STATE ---
        let selectedFiles = [];

        // --- EVENT LISTENERS ---
        
        // Toggle Settings
        settingsBtn.addEventListener("click", () => {
            urlConfig.classList.toggle("hidden");
        });

        // Update Script URL from input
        scriptUrlInput.addEventListener("change", (e) => {
            SCRIPT_URL = e.target.value;
        });

        // File Selection
        input.addEventListener("change", () => {
            // Hide previous status message when selecting new files
            statusMessage.classList.add("hidden");
            
            preview.innerHTML = "";
            selectedFiles = [...input.files];
            const fileCount = selectedFiles.length;
            countSpan.textContent = `${fileCount} file${fileCount !== 1 ? 's' : ''}`;
            
            // Enable/Disable upload button
            uploadBtn.disabled = fileCount === 0;

            if (fileCount === 0) {
                preview.appendChild(placeholder);
                return;
            }

            selectedFiles.forEach(file => {
                if (!file.type.startsWith('image/')) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imgContainer = document.createElement('div');
                    imgContainer.className = "relative group aspect-square bg-gray-100 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all duration-300";
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = "w-full h-full object-cover transition-transform duration-500 group-hover:scale-110";
                    
                    const overlay = document.createElement('div');
                    overlay.className = "absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center p-2";
                    
                    const fileName = document.createElement('span');
                    fileName.className = "text-white text-xs font-medium truncate w-full text-center";
                    fileName.textContent = file.name;

                    overlay.appendChild(fileName);
                    imgContainer.appendChild(img);
                    imgContainer.appendChild(overlay);
                    preview.appendChild(imgContainer);
                };
                reader.readAsDataURL(file);
            });
        });

        // Upload Action
        uploadBtn.addEventListener("click", async () => {
            if (selectedFiles.length === 0) return;
            if (SCRIPT_URL.includes("YOUR_WEB_APP_URL_HERE") && !scriptUrlInput.value) {
                alert("Please set your Google Apps Script Web App URL first!");
                urlConfig.classList.remove("hidden");
                return;
            }

            // UI Loading State
            setLoading(true);
            progressContainer.classList.remove("hidden");
            statusMessage.classList.add("hidden");
            
            let successCount = 0;
            let failCount = 0;

            // Process files one by one to avoid payload limits
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                updateProgress(i, selectedFiles.length);

                try {
                    const base64 = await toBase64(file);
                    // Remove header (e.g., "data:image/png;base64,") for Google Apps Script
                    const cleanBase64 = base64.split(',')[1]; 

                    const payload = {
                        filename: file.name,
                        mimeType: file.type,
                        base64: cleanBase64
                    };

                    // Send to Google Apps Script
                    await fetch(SCRIPT_URL, {
                        method: "POST",
                        body: JSON.stringify(payload)
                    });

                    successCount++;
                } catch (error) {
                    console.error("Upload failed", error);
                    failCount++;
                }
            }

            // Finish
            updateProgress(selectedFiles.length, selectedFiles.length);
            setLoading(false);
            
            // Show result
            statusMessage.className = `mb-4 p-4 rounded-md text-sm ${failCount === 0 ? 'bg-green-50 text-green-700' : 'bg-orange-50 text-orange-700'}`;
            statusMessage.textContent = failCount === 0 
                ? `✅ Successfully uploaded ${successCount} images!` 
                : `⚠️ Uploaded ${successCount} images. ${failCount} failed.`;
            statusMessage.classList.remove("hidden");

            // --- RESET LOGIC ---
            if (successCount > 0) {
                // Wait 1.5 seconds so user can see the 100% and success message
                setTimeout(() => {
                    // 1. Clear actual file input
                    input.value = "";
                    
                    // 2. Clear state array
                    selectedFiles = [];
                    
                    // 3. Reset visual preview to placeholder
                    preview.innerHTML = "";
                    preview.appendChild(placeholder);
                    
                    // 4. Reset counter text
                    countSpan.textContent = "0 files";
                    
                    // 5. Disable upload button again
                    uploadBtn.disabled = true;
                    
                    // 6. Hide progress bar (optional, keeps interface clean)
                    progressContainer.classList.add("hidden");
                    progressBar.style.width = "0%";
                    progressPercentage.textContent = "0%";
                    
                    // Note: We keep statusMessage visible so they know it worked, 
                    // until they select new files (see the input 'change' listener).
                }, 1500);
            }
        });

        // --- HELPERS ---

        function updateProgress(current, total) {
            const percent = Math.round((current / total) * 100);
            progressBar.style.width = `${percent}%`;
            progressPercentage.textContent = `${percent}%`;
        }

        function setLoading(isLoading) {
            uploadBtn.disabled = isLoading;
            if (isLoading) {
                btnText.textContent = "Uploading...";
                btnLoader.classList.remove("hidden");
            } else {
                btnText.textContent = "Upload to Drive";
                btnLoader.classList.add("hidden");
            }
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    </script>
</body>
</html>
